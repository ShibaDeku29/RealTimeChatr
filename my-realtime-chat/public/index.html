<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>Realtime Chat Pro — Phase A</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/styles.css?v=5" />
  <script src="/socket.io/socket.io.js"></script>
</head>
<body>
  <div class="wrap">
    <!-- Header -->
    <header class="topbar card">
      <div class="brand">
        <div class="spark"></div>
        <h2>Realtime Chat Pro — Phase A</h2>
      </div>

      <div class="actions">
        <button id="toggleLeft" class="btn ghost small">Sidebar</button>
        <button id="toggleRight" class="btn ghost small">DM</button>
        <div id="userBadge" class="user-badge" aria-live="polite"></div>
      </div>
    </header>

    <!-- LAYOUT 3 CỘT -->
    <div class="layout-3col">

      <!-- SIDEBAR TRÁI -->
      <aside id="leftCol" class="card sidebar">
        <h3 class="sec-title">Phòng</h3>
        <div class="room-join">
          <input id="room" class="room-input" placeholder="vd: general" value="general"/>
          <button id="btnJoin" class="btn ghost">Join</button>
        </div>

        <h4 class="sec-sub">Đang online</h4>
        <div id="presence" class="presence-list"></div>
      </aside>

      <!-- CHAT CHÍNH -->
      <main class="card chat-main">
        <div id="log" class="scrollbox chatbox"></div>

        <div class="composer">
          <input id="text" placeholder="Viết tin nhắn..." />
          <button id="btnSend" class="btn icon" title="Gửi">
            <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
              <path d="M22 2L11 13" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M22 2L15 22l-4-9-9-4 20-7Z" fill="currentColor"/>
            </svg>
          </button>
        </div>
        <small id="typing" class="sys"></small>
      </main>

      <!-- DM PANE PHẢI -->
      <aside id="rightCol" class="card dm-pane">
        <h3 class="sec-title">DM</h3>
        <input id="dmUser" class="to-input" placeholder="DM tới username..." />
        <div id="dmLog" class="scrollbox chatbox"></div>
        <div class="composer">
          <input id="dmText" placeholder="Tin nhắn DM..." />
          <button id="btnSendDm" class="btn icon" title="Gửi DM">
            <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true">
              <path d="M22 2L11 13" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              <path d="M22 2L15 22l-4-9-9-4 20-7Z" fill="currentColor"/>
            </svg>
          </button>
        </div>
      </aside>

    </div>
  </div>

<script>
  /* ===== token & badge ===== */
  const token = localStorage.getItem('chat_token');
  if (!token) location.href = "/login.html";

  function parseJwt(tk){
    try{ return JSON.parse(atob(tk.split('.')[1].replace(/-/g,'+').replace(/_/g,'/'))); }
    catch{ return null; }
  }
  const payload = parseJwt(token);
  const username = payload?.username || "User";
  const initials = (n)=> (n.trim().split(/[\s_]+/).slice(0,2).map(s=>s[0]).join('')||'U').toUpperCase();

  const userBadge = document.getElementById('userBadge');
  userBadge.innerHTML = `
    <div class="user">
      <div class="avatar">${initials(username)}</div>
      <div class="who"><strong>@${username}</strong><small>đang trực tuyến</small></div>
      <button id="btnLogout" class="btn ghost small">Logout</button>
    </div>`;
  document.getElementById('btnLogout').onclick = ()=>{ localStorage.removeItem('chat_token'); location.href="/login.html"; };

  /* ===== layout toggles (mobile) ===== */
  const leftCol = document.getElementById('leftCol');
  const rightCol = document.getElementById('rightCol');
  document.getElementById('toggleLeft').onclick  = ()=> leftCol.classList.toggle('open');
  document.getElementById('toggleRight').onclick = ()=> rightCol.classList.toggle('open');

  /* ===== helpers ===== */
  const $ = s => document.querySelector(s);
  const fmtTime = ts => new Date((String(ts).length>10?ts:ts*1000)).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});

  let lastDayKeyRoom = "", lastDayKeyDM = "";
  const dayKey = ts => {
    const d = new Date((String(ts).length>10?ts:ts*1000));
    return `${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`;
  };
  function addSeparator(container, ts){
    const d = new Date((String(ts).length>10?ts:ts*1000));
    const label = d.toLocaleDateString([], {year:'numeric', month:'short', day:'numeric'});
    const sep = document.createElement('div');
    sep.className = 'day-sep';
    sep.innerHTML = `<span>${label}</span>`;
    container.appendChild(sep);
  }

  function addMessage(container, { from, text, ts, self=false }) {
    const currentKey = dayKey(ts || Date.now());
    if(container.id==='log'){
      if (currentKey !== lastDayKeyRoom){ addSeparator(container, ts||Date.now()); lastDayKeyRoom = currentKey; }
    } else {
      if (currentKey !== lastDayKeyDM){ addSeparator(container, ts||Date.now()); lastDayKeyDM = currentKey; }
    }

    const row = document.createElement('div');
    row.className = `msg-row${self?' me':''}`;

    const av = document.createElement('div');
    av.className = 'avatar';
    av.textContent = initials(from);

    const bubble = document.createElement('div');
    bubble.className = 'bubble';
    bubble.innerHTML = `
      <div class="meta">
        <span class="name">${from}</span>
        <span class="time">${fmtTime(ts || Date.now())}</span>
      </div>
      <div class="text"></div>
      <span class="tail" aria-hidden="true"></span>
    `;
    bubble.querySelector('.text').textContent = text;

    if(self){ row.appendChild(bubble); row.appendChild(av); }
    else    { row.appendChild(av); row.appendChild(bubble); }

    container.appendChild(row);
    container.scrollTop = container.scrollHeight;
  }

  /* ===== socket ===== */
  let socket = io("/chat", { auth: { token } });
  let currentRoom = null;

  socket.on("connect", ()=>{
    currentRoom = $("#room").value.trim() || "general";
    socket.emit("join_room", { slug: currentRoom });
  });

  socket.on("history", ({slug, messages})=>{
    if(slug!==currentRoom) return;
    $("#log").innerHTML = ""; lastDayKeyRoom = "";
    for(const m of messages){
      addMessage($("#log"), { from: m.fromUser, text: m.content, ts: m.ts, self: m.fromUser===username });
    }
  });

  socket.on("room_message", (m)=>{
    if(m.slug!==currentRoom) return;
    addMessage($("#log"), { from: m.from, text: m.content, ts: m.ts, self: m.from===username });
  });

  socket.on("presence", ({slug, users})=>{
    if(slug!==currentRoom) return;
    document.getElementById('presence').innerHTML =
      users.map(u=>`<div class="presence-item"><div class="dot"></div><span>${u}</span></div>`).join("");
  });

  let typingTimer=null;
  socket.on("typing", ({slug, from})=>{
    if(slug!==currentRoom) return;
    $("#typing").textContent = `${from} đang gõ...`;
    clearTimeout(typingTimer);
    typingTimer = setTimeout(()=>$("#typing").textContent="", 900);
  });

  socket.on("dm_message", (m)=>{
    const self = m.from===username;
    addMessage($("#dmLog"), { from: self?username:m.from, text: m.content, ts: m.ts, self });
  });

  /* ===== actions ===== */
  $("#btnJoin").onclick = ()=>{
    const slug = $("#room").value.trim() || "general";
    if(currentRoom) socket.emit("leave_room", { slug: currentRoom });
    currentRoom = slug;
    $("#log").innerHTML = ""; lastDayKeyRoom = "";
    socket.emit("join_room", { slug });
  };

  $("#text").addEventListener("input", ()=>{
    if(currentRoom) socket.emit("typing", { slug: currentRoom });
  });

  $("#btnSend").onclick = ()=>{
    const t = $("#text").value.trim();
    if(!t || !currentRoom) return;
    const tempId = crypto.randomUUID();
    addMessage($("#log"), { from: username, text: t, ts: Date.now(), self: true });
    socket.emit("send_room", { slug: currentRoom, content: t, tempId });
    $("#text").value = "";
  };

  $("#btnSendDm").onclick = ()=>{
    const to = $("#dmUser").value.trim();
    const t = $("#dmText").value.trim();
    if(!to || !t) return;
    const tempId = crypto.randomUUID();
    addMessage($("#dmLog"), { from: username, text: t, ts: Date.now(), self: true });
    socket.emit("send_dm", { toUsername: to, content: t, tempId });
    $("#dmText").value = "";
  };
</script>
</body>
</html>
