<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>Realtime Chat Pro — Phase A</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/styles.css?v=3" />
  <script src="/socket.io/socket.io.js"></script>
</head>
<body>
  <div class="wrap">
    <!-- Header -->
    <header class="topbar card">
      <h2>Realtime Chat Pro — Phase A</h2>
      <div id="userBadge" class="user-badge" aria-live="polite"></div>
    </header>

    <!-- 2 cột: Room & DM -->
    <div class="side">
      <!-- Cột phòng -->
      <div class="card">
        <div class="row">
          <input id="room" placeholder="slug phòng (vd: general)" value="general"/>
          <button id="btnJoin">Join room</button>
          <span id="presence"></span>
        </div>

        <!-- message list style mới -->
        <div id="log" class="scrollbox"></div>

        <div class="row">
          <input id="text" placeholder="Tin nhắn..." />
          <button id="btnSend">Gửi</button>
        </div>
        <small id="typing" class="sys"></small>
      </div>

      <!-- Cột DM -->
      <div class="card">
        <div class="col">
          <div class="row">
            <input id="dmUser" placeholder="DM tới username..." />
          </div>
          <div id="dmLog" class="scrollbox"></div>
          <div class="row">
            <input id="dmText" placeholder="Tin nhắn DM..." />
            <button id="btnSendDm">Gửi DM</button>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  /* ===== gate token & user badge ===== */
  const token = localStorage.getItem('chat_token');
  if (!token) location.href = "/login.html";

  function parseJwt(tk){
    try{ return JSON.parse(atob(tk.split('.')[1].replace(/-/g,'+').replace(/_/g,'/'))); }
    catch{ return null; }
  }
  const payload = parseJwt(token);
  const username = payload?.username || "User";

  function initials(name){
    return (name.trim().split(/[\s_]+/).slice(0,2).map(s=>s[0]).join('') || 'U').toUpperCase();
  }
  const userBadge = document.getElementById('userBadge');
  userBadge.innerHTML = `
    <div class="user">
      <div class="avatar">${initials(username)}</div>
      <div class="who"><strong>@${username}</strong><small>đang trực tuyến</small></div>
      <button id="btnLogout" class="btn ghost small">Logout</button>
    </div>`;
  document.getElementById('btnLogout').onclick = ()=>{ localStorage.removeItem('chat_token'); location.href="/login.html"; };

  /* ===== helpers ===== */
  const $ = s => document.querySelector(s);
  const fmtTime = ts => new Date((String(ts).length>10?ts:ts*1000)).toLocaleTimeString();

  function addMessage(container, { from, text, ts, self=false }) {
    const row = document.createElement('div');
    row.className = `msg-row${self?' me':''}`;

    const av = document.createElement('div');
    av.className = 'avatar';
    av.textContent = initials(from);

    const bubble = document.createElement('div');
    bubble.className = 'bubble';
    bubble.innerHTML = `
      <div class="meta">
        <span class="name">${from}</span>
        <span class="time">${fmtTime(ts || Date.now())}</span>
      </div>
      <div class="text"></div>
    `;
    bubble.querySelector('.text').textContent = text;

    if(self){ row.appendChild(bubble); row.appendChild(av); }
    else    { row.appendChild(av); row.appendChild(bubble); }

    container.appendChild(row);
    container.scrollTop = container.scrollHeight;
  }

  /* ===== socket ===== */
  let socket = io("/chat", { auth: { token } });
  let currentRoom = null;

  socket.on("connect", ()=>{
    currentRoom = $("#room").value.trim() || "general";
    socket.emit("join_room", { slug: currentRoom });
  });

  // lịch sử phòng khi join
  socket.on("history", ({slug, messages})=>{
    if(slug!==currentRoom) return;
    $("#log").innerHTML = "";
    for(const m of messages){
      addMessage($("#log"), { from: m.fromUser, text: m.content, ts: m.ts, self: m.fromUser===username });
    }
  });

  // tin nhắn phòng realtime
  socket.on("room_message", (m)=>{
    if(m.slug!==currentRoom) return;
    addMessage($("#log"), { from: m.from, text: m.content, ts: m.ts, self: m.from===username });
  });

  // presence
  socket.on("presence", ({slug, users})=>{
    if(slug!==currentRoom) return;
    $("#presence").innerHTML = users.map(u=>`<span class="pill">${u}</span>`).join("");
  });

  // typing mượt
  let typingTimer=null;
  socket.on("typing", ({slug, from})=>{
    if(slug!==currentRoom) return;
    $("#typing").textContent = `${from} đang gõ...`;
    clearTimeout(typingTimer);
    typingTimer = setTimeout(()=>$("#typing").textContent="", 900);
  });

  // DM
  socket.on("dm_message", (m)=>{
    const self = m.from===username;
    addMessage($("#dmLog"), { from: self?username:m.from, text: m.content, ts: m.ts, self });
  });

  socket.on("delivered", ({id,tempId})=>{/* có thể xử lý trạng thái gửi theo tempId nếu muốn */});

  /* ===== actions ===== */
  $("#btnJoin").onclick = ()=>{
    const slug = $("#room").value.trim() || "general";
    if(currentRoom) socket.emit("leave_room", { slug: currentRoom });
    currentRoom = slug;
    $("#log").innerHTML = "";
    socket.emit("join_room", { slug });
  };

  $("#text").addEventListener("input", ()=>{
    if(currentRoom) socket.emit("typing", { slug: currentRoom });
  });

  $("#btnSend").onclick = ()=>{
    const t = $("#text").value.trim();
    if(!t || !currentRoom) return;
    const tempId = crypto.randomUUID();
    // render ngay ở client để thấy mượt
    addMessage($("#log"), { from: username, text: t, ts: Date.now(), self: true });
    socket.emit("send_room", { slug: currentRoom, content: t, tempId });
    $("#text").value = "";
  };

  $("#btnSendDm").onclick = ()=>{
    const to = $("#dmUser").value.trim();
    const t = $("#dmText").value.trim();
    if(!to || !t) return;
    const tempId = crypto.randomUUID();
    addMessage($("#dmLog"), { from: username, text: t, ts: Date.now(), self: true });
    socket.emit("send_dm", { toUsername: to, content: t, tempId });
    $("#dmText").value = "";
  };
</script>
</body>
</html>
