<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>Realtime Chat Pro — Phase A</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/styles.css?v=2" />
  <script src="/socket.io/socket.io.js"></script>
</head>
<body>
  <div class="wrap">
    <!-- Header với user badge -->
    <header class="topbar card">
      <h2>Realtime Chat Pro — Phase A</h2>
      <div id="userBadge" class="user-badge" aria-live="polite"></div>
    </header>

    <!-- LAYOUT 2 cột chat/DM (không còn auth form) -->
    <div class="side">
      <!-- Cột phòng -->
      <div class="card">
        <div class="row">
          <input id="room" placeholder="slug phòng (vd: general)" value="general"/>
          <button id="btnJoin">Join room</button>
          <span id="presence"></span>
        </div>

        <div id="log"></div>

        <div class="row">
          <input id="text" placeholder="Tin nhắn..." />
          <button id="btnSend">Gửi</button>
        </div>
        <small id="typing" class="sys"></small>
      </div>

      <!-- Cột DM -->
      <div class="card">
        <div class="col">
          <div class="row">
            <input id="dmUser" placeholder="DM tới username..." />
          </div>
          <div id="dmLog" class="scrollbox"></div>
          <div class="row">
            <input id="dmText" placeholder="Tin nhắn DM..." />
            <button id="btnSendDm">Gửi DM</button>
          </div>
        </div>
      </div>
    </div>
  </div>

<script>
  // ---- Gate: nếu chưa có token → chuyển về trang login
  const token = localStorage.getItem('chat_token');
  if (!token) {
    window.location.href = "/login.html";
  }

  // ---- Decode JWT (không verify; chỉ để đọc payload hiển thị)
  function parseJwt(tk){
    try{
      const p = tk.split('.')[1];
      return JSON.parse(atob(p.replace(/-/g,'+').replace(/_/g,'/')));
    }catch{ return null; }
  }
  const payload = parseJwt(token);
  const username = payload?.username || "User";

  // ---- Render user badge
  function initials(name){
    const x = name.trim().split(/[\s_]+/).slice(0,2).map(s=>s[0]||'').join('').toUpperCase();
    return x || 'U';
  }
  const userBadge = document.getElementById('userBadge');
  userBadge.innerHTML = `
    <div class="user">
      <div class="avatar" aria-hidden="true">${initials(username)}</div>
      <div class="who">
        <strong>@${username}</strong>
        <small>đang trực tuyến</small>
      </div>
      <button id="btnLogout" class="btn ghost small" title="Đăng xuất">Logout</button>
    </div>
  `;
  document.getElementById('btnLogout').onclick = () => {
    localStorage.removeItem('chat_token');
    window.location.href = "/login.html";
  };

  // ---- Helpers DOM
  const $ = s => document.querySelector(s);
  const log = (el, html) => { el.insertAdjacentHTML('beforeend', html); el.scrollTop = el.scrollHeight; };

  // ---- Kết nối Socket.IO với token
  let socket = io("/chat", { auth: { token } });
  let currentRoom = null;

  socket.on("connect", ()=> {
    // auto join phòng general lần đầu
    const slug = $("#room").value.trim() || "general";
    currentRoom = slug;
    socket.emit("join_room", { slug });
  });

  // ---- History/presence/typing
  socket.on("history", ({slug, messages})=>{
    if(slug===currentRoom){
      $("#log").innerHTML = "";
      for(const m of messages){
        log($("#log"), `<div class="msg"><b>${m.fromUser}</b>: ${m.content} <small>@${new Date(m.ts*1000).toLocaleTimeString()}</small></div>`);
      }
    }
  });

  socket.on("room_message", (m)=>{
    if(m.slug===currentRoom){
      log($("#log"), `<div class="msg"><b>${m.from}</b>: ${m.content} <small>@${new Date(m.ts*1000).toLocaleTimeString()}</small></div>`);
    }
  });

  socket.on("presence", ({slug, users})=>{
    if(slug===currentRoom){
      $("#presence").innerHTML = users.map(u=>`<span class="pill">${u}</span>`).join("");
    }
  });

  let typingTimer = null;
  socket.on("typing", ({slug, from})=>{
    if(slug===currentRoom){
      $("#typing").textContent = `${from} đang gõ...`;
      clearTimeout(typingTimer);
      typingTimer = setTimeout(()=>$("#typing").textContent="", 1000);
    }
  });

  // ---- DM
  socket.on("dm_message", (m)=>{
    log($("#dmLog"), `<div class="msg"><b>${m.from} → ${m.to||'you'}</b>: ${m.content} <small>@${new Date(m.ts*1000).toLocaleTimeString()}</small></div>`);
  });

  socket.on("delivered", ({id,tempId})=>{/* có thể đánh dấu trạng thái gửi theo tempId nếu muốn */});

  // ---- Actions
  $("#btnJoin").onclick = ()=>{
    const slug = $("#room").value.trim() || "general";
    if (currentRoom) socket.emit("leave_room", { slug: currentRoom });
    currentRoom = slug;
    $("#log").innerHTML = "";
    socket.emit("join_room", { slug });
  };

  $("#text").addEventListener("input", ()=>{
    if(currentRoom && socket) socket.emit("typing", { slug: currentRoom });
  });

  $("#btnSend").onclick = ()=>{
    const t = $("#text").value.trim();
    if(!t || !currentRoom) return;
    const tempId = crypto.randomUUID();
    socket.emit("send_room", { slug: currentRoom, content: t, tempId });
    $("#text").value = "";
  };

  $("#btnSendDm").onclick = ()=>{
    const to = $("#dmUser").value.trim();
    const t = $("#dmText").value.trim();
    if(!to || !t) return;
    const tempId = crypto.randomUUID();
    socket.emit("send_dm", { toUsername: to, content: t, tempId });
    $("#dmText").value = "";
  };
</script>
</body>
</html>
